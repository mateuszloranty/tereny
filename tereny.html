<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, 
          maximum-scale=1.0, user-scalable=no">
    <title>Mapa rejonu</title>

    <!-- Leaflet CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- <link rel="stylesheet" href="leaflet.css" /> -->

    <style>
        *, *::before, *::after { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        /* === KLUCZOWY FIX DLA LEAFLET === */
        .leaflet-container,
        .leaflet-container * {
            box-sizing: content-box;
        }
        .leaflet-container img {
            max-width: none !important;
            max-height: none !important;
        }
        /* ================================ */

        body {
            font-family: -apple-system, BlinkMacSystemFont, 
                        'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 14px 16px;
            text-align: center;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .subtitle { 
            font-size: 13px; opacity: 0.8; margin-top: 4px; 
        }

        #map {
            width: 100%;
            height: 55vh;
            min-height: 300px;
        }

        .info-bar {
            background: white;
            padding: 10px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        .info-bar .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .info-bar .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .dot-searching { background: #f39c12; animation: pulse 1s infinite; }
        .dot-found     { background: #27ae60; }
        .dot-error     { background: #e74c3c; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%      { opacity: 0.3; }
        }

        .buttons {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-google { background: linear-gradient(135deg, #4285F4, #356AC3); }
        .btn-waze   { background: linear-gradient(135deg, #33CCFF, #05A8D6); }
        .btn-apple  { background: linear-gradient(135deg, #333, #111); }
        .btn-navigate {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-group .btn { flex: 1; font-size: 14px; padding: 12px 10px; }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 16px;
            margin-top: 8px;
        }

        .legend {
            padding: 10px 16px;
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        .region-status {
            text-align: center;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 14px;
        }
        .status-inside  { background: #d4edda; color: #155724; }
        .status-outside { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="region-name">Rejon</h1>
    <div class="subtitle">Zeskanowano kod rejonu</div>
</div>

<div id="map"></div>

<div class="info-bar">
    <span class="status">
        <span id="gps-dot" class="dot dot-searching"></span>
        <span id="gps-status">Szukam Twojej lokalizacji...</span>
    </span>
</div>

<div id="region-status-bar"></div>

<div class="buttons">
    <div class="section-title">üìç Zobacz rejon w aplikacji</div>
    <div class="btn-group">
        <a id="btn-google" class="btn btn-google" href="#">
            Google Maps
        </a>
        <a id="btn-waze" class="btn btn-waze" href="#">
            Waze
        </a>
        <a id="btn-apple" class="btn btn-apple" href="#">
            Apple Maps
        </a>
    </div>

    <div class="section-title" style="margin-top: 14px;">
        üß≠ Nawiguj do centrum rejonu
    </div>
    <a id="btn-navigate" class="btn btn-navigate" href="#">
        Rozpocznij nawigacjƒô
    </a>
</div>

<div class="legend">
    <span style="color: var(--poly-color, #e74c3c);">‚ñ†</span> 
    Granica rejonu &nbsp;|&nbsp; 
    <span style="color: #2196F3;">‚óè</span> Twoja lokalizacja
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- <script src="leaflet.js"></script> -->

<script>
(function() {
    // ============================================================
    // 1. PARSOWANIE PARAMETR√ìW URL
    // ============================================================
    const params  = new URLSearchParams(window.location.search);
    const name    = params.get('name') || 'Rejon';
    const polyStr = params.get('poly');          // lat,lng,lat,lng,...
    const color   = params.get('color') || '#e74c3c';

    document.getElementById('region-name').textContent = name;
    document.title = name + ' ‚Äî Mapa rejonu';
    document.documentElement.style.setProperty('--poly-color', color);

    if (!polyStr) {
        document.getElementById('map').innerHTML = 
            '<p style="padding:40px;text-align:center;">' +
            'Brak danych wielokƒÖta w URL.</p>';
        return;
    }

    // ============================================================
    // 2. PRZETWARZANIE WSP√ì≈ÅRZƒòDNYCH
    // ============================================================
    const raw     = polyStr.split(',').map(Number);
    const latlngs = [];
    for (let i = 0; i < raw.length; i += 2) {
        if (!isNaN(raw[i]) && !isNaN(raw[i + 1])) {
            latlngs.push([raw[i], raw[i + 1]]);
        }
    }

    // ≈örodek geometryczny (centroid)
    const centerLat = latlngs.reduce((s, c) => s + c[0], 0) / latlngs.length;
    const centerLng = latlngs.reduce((s, c) => s + c[1], 0) / latlngs.length;

    // ============================================================
    // 3. INICJALIZACJA MAPY
    // ============================================================
    const map = L.map('map', {
        zoomControl: true,
        attributionControl: false
    });

    // Warstwa OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Rysowanie wielokƒÖta
    const polygon = L.polygon(latlngs, {
        color:       color,
        fillColor:   color,
        fillOpacity: 0.15,
        weight:      3,
        dashArray:   null
    }).addTo(map);

    // Marker ≈õrodka
    L.circleMarker([centerLat, centerLng], {
        radius:      6,
        color:       color,
        fillColor:   color,
        fillOpacity: 0.8
    }).addTo(map).bindPopup('Centrum rejonu: ' + name);

    // Dopasuj widok do wielokƒÖta
    map.fitBounds(polygon.getBounds(), { padding: [40, 40] });

    setTimeout(function() {
        map.invalidateSize();
    }, 200);

    // ============================================================
    // 4. DEEP LINKI DO APLIKACJI MAPOWYCH
    // ============================================================
    const cLat = centerLat.toFixed(6);
    const cLng = centerLng.toFixed(6);

    // Google Maps ‚Äî otwiera punkt
    document.getElementById('btn-google').href =
        `https://www.google.com/maps/search/?api=1&query=${cLat},${cLng}`;

    // Waze
    document.getElementById('btn-waze').href =
        `https://waze.com/ul?ll=${cLat},${cLng}&z=14&navigate=yes`;

    // Apple Maps
    document.getElementById('btn-apple').href =
        `https://maps.apple.com/?ll=${cLat},${cLng}&z=14&q=${encodeURIComponent(name)}`;

    // Nawigacja ‚Äî u≈ºyj schematu intent / universal link
    // google.navigation na Androidzie, maps.apple.com na iOS
    const navBtn = document.getElementById('btn-navigate');

    function setNavigationLink() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            navBtn.href = 
                `https://maps.apple.com/?daddr=${cLat},${cLng}&dirflg=d`;
        } else {
            // Android ‚Äî otworzy wyb√≥r aplikacji
            navBtn.href = 
                `https://www.google.com/maps/dir/?api=1&destination=${cLat},${cLng}&travelmode=driving`;
        }
    }
    setNavigationLink();

    // ============================================================
    // 5. GEOLOKALIZACJA U≈ªYTKOWNIKA
    // ============================================================
    let userMarker  = null;
    let userCircle  = null;
    const gpsDot    = document.getElementById('gps-dot');
    const gpsStatus = document.getElementById('gps-status');
    const statusBar = document.getElementById('region-status-bar');

    // Algorytm ray-casting ‚Äî czy punkt jest w wielokƒÖcie
    function isPointInPolygon(point, polygon) {
        const [px, py] = point;
        let inside = false;
        for (let i = 0, j = polygon.length - 1; 
             i < polygon.length; j = i++) {
            const [ix, iy] = polygon[i];
            const [jx, jy] = polygon[j];
            if (((iy > py) !== (jy > py)) &&
                (px < (jx - ix) * (py - iy) / (jy - iy) + ix)) {
                inside = !inside;
            }
        }
        return inside;
    }

    function onLocationFound(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        gpsDot.className    = 'dot dot-found';
        gpsStatus.textContent = 
            `Lokalizacja znaleziona (¬±${Math.round(acc)}m)`;

        if (userMarker) {
            userMarker.setLatLng([lat, lng]);
            userCircle.setLatLng([lat, lng]).setRadius(acc);
        } else {
            userMarker = L.circleMarker([lat, lng], {
                radius:      8,
                color:       '#2196F3',
                fillColor:   '#2196F3',
                fillOpacity: 0.9,
                weight:      3,
                className:   'user-marker'
            }).addTo(map).bindPopup('Twoja lokalizacja');

            userCircle = L.circle([lat, lng], {
                radius:      acc,
                color:       '#2196F3',
                fillColor:   '#2196F3',
                fillOpacity: 0.08,
                weight:      1
            }).addTo(map);
        }

        // Sprawd≈∫ czy u≈ºytkownik jest w rejonie
        const inside = isPointInPolygon([lat, lng], latlngs);
        statusBar.className = 'region-status ' + 
            (inside ? 'status-inside' : 'status-outside');
        statusBar.textContent = inside
            ? '‚úÖ Jeste≈õ w granicach tego rejonu'
            : '‚ö†Ô∏è Jeste≈õ poza granicami tego rejonu';

        // Aktualizuj link nawigacji ‚Äî z aktualnej pozycji
        const navBtn = document.getElementById('btn-navigate');
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            navBtn.href = 
                `https://maps.apple.com/?saddr=${lat},${lng}&daddr=${cLat},${cLng}&dirflg=d`;
        } else {
            navBtn.href = 
                `https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${cLat},${cLng}&travelmode=driving`;
        }
    }

    function onLocationError(err) {
        gpsDot.className      = 'dot dot-error';
        gpsStatus.textContent = 'Nie uda≈Ço siƒô pobraƒá lokalizacji';
        console.warn('Geolocation error:', err.message);
    }

    if (navigator.geolocation) {
        // Jednorazowy odczyt
        navigator.geolocation.getCurrentPosition(
            onLocationFound, onLocationError,
            { enableHighAccuracy: true, timeout: 10000 }
        );
        // CiƒÖg≈Çe ≈õledzenie
        navigator.geolocation.watchPosition(
            onLocationFound, onLocationError,
            { enableHighAccuracy: true, maximumAge: 5000 }
        );
    } else {
        gpsDot.className      = 'dot dot-error';
        gpsStatus.textContent = 'Geolokalizacja niedostƒôpna';
    }

})();
</script>

</body>
</html>
